<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>温度热力图</title>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <style>
    /* 样式表中添加 .tooltip 样式，用于提示框 */
    .tooltip {
      position: absolute;
      background-color: white;
      border: solid 1px gray;
      padding: 5px;
      opacity: 0;
    }
  </style>
</head>

<body>

  <!-- 添加一个带有 id="heatmap" 的 div 元素 -->
  <div id="heatmap"></div>

  <script>
    d3.csv("https://raw.githubusercontent.com/realRoosterWho/DataVIsualization_RW/hw1/temperature.csv?token=GHSAT0AAAAAAB645HTR76FZGFY3EQISNBJAY7W2C2Q", function(error, data) {
      if (error) throw error;

      // 将 Anomaly 列的值存储到数组中
      var values = data.map(function(d) {
        return +d.Anomaly;
      });
    
      // 计算数据中的最大值和最小值
      var maxValue = d3.max(values);
      var minValue = d3.min(values);

      // 设置画布大小
      var margin = { top: 40, right: 20, bottom: 60, left: 60 },
        width = 500 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;

      // 创建 SVG 元素
      var svg = d3.select("#heatmap")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      // 定义颜色比例尺
      var colorScale = d3.scaleLinear()
        .domain([minValue, maxValue])
        .range(["#d6eaf8", "#21618c"]);

      // 定义每个单元格的大小
      var gridSize = Math.min(width / data.length, height / 12);

      // 定义 tooltip
      var tooltip = d3.select("body")
        .append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

      // 定义左侧的坐标轴
      var yAxisScale = d3.scaleBand()
        .range([0, height])
        .domain(data.map(function(d) {
          return d.Year;
        }))
        .padding(0.01);

      var yAxis = d3.axisLeft(yAxisScale);

      svg.append("g")
        .attr("class", "y axis")
        .call(yAxis);

// 定义下面的坐标轴
var xAxis = d3.axisBottom(xScale)
    .tickFormat(d3.format("d"));

svg.append("g")
    .attr("class", "x axis")
    .attr("transform", "translate(0," + height + ")")
    .call(xAxis)
    .selectAll("text")
    .style("text-anchor", "end")
    .attr("dx", "-.8em")
    .attr("dy", "-.55em")
    .attr("transform", "rotate(-90)");

// 定义左侧的坐标轴
var yAxis = d3.axisLeft(yScale)
    .tickFormat(d3.format("d"));

svg.append("g")
    .attr("class", "y axis")
    .call(yAxis);

// 添加热力图的数值
var heatMap = svg.selectAll(".heatmap")
    .data(data)
    .enter().append("g")
    .attr("class", "heatmap");

heatMap.selectAll("rect")
    .data(function(d) { return d; })
    .enter().append("rect")
    .attr("x", function(d, i, j) { return xScale(j); })
    .attr("y", function(d, i, j) { return yScale(i); })
    .attr("width", gridSize)
    .attr("height", gridSize)
    .style("fill", function(d) { return colorScale(d.Anomaly); })
    .on("mouseover", function() {
        tooltip.transition()
            .duration(200)
            .style("opacity", .9);
        tooltip.html(d3.select(this).data()[0].Anomaly)
            .style("left", (d3.event.pageX) + "px")
            .style("top", (d3.event.pageY - 28) + "px");
    })
    .on("mouseout", function() {
        tooltip.transition()
            .duration(500)
            .style("opacity", 0);
    });

// 添加颜色比例尺
var legend = svg.selectAll(".legend")
    .data(colorScale.ticks(6).slice(1).reverse())
    .enter().append("g")
    .attr("class", "legend")
    .attr("transform", function(d, i) { return "translate(" + (width + 20) + "," + (20 + i * 20) + ")"; });

legend.append("rect")
    .attr("width", 20)
    .attr("height", 20)
    .style("fill", colorScale);

legend.append("text")
    .attr("x", 26)
    .attr("y", 10)
    .attr("dy", ".35em")
    .text(function(d) { return "> " + d.toFixed(1); });

// 添加标题
svg.append("text")
    .attr("x", (width / 2))
    .attr("y", 0 - (margin.top / 2))
    .attr("text-anchor", "middle")
    .style("font-size", "20px")
    .text("Monthly Global Land-Surface Temperature");

  // 添加 y 轴标签
  svg.append("text")
    .attr("class", "label")
    .attr("text-anchor", "middle")
    .attr("transform", "rotate(-90)")
    .attr("y", -margin.left)
    .attr("x", -height / 2)
    .text("Year");

  // 添加 x 轴标签
  svg.append("text")
    .attr("class", "label")
    .attr("text-anchor", "middle")
    .attr("x", width / 2)
    .attr("y", height + margin.bottom - 10)
    .text("Month");

  // 定义颜色比例尺
  var colorScale = d3.scaleSequential()
    .domain([d3.min(data, function(d) { return d.Anomaly; }), d3.max(data, function(d) { return d.Anomaly; })])
    .interpolator(d3.interpolateInferno);

  // 定义每个单元格的大小
  var gridSizeX = width / (d3.max(data, function(d) { return d.Month; }) - d3.min(data, function(d) { return d.Month; }) + 1),
      gridSizeY = height / (d3.max(data, function(d) { return d.Year; }) - d3.min(data, function(d) { return d.Year; }) + 1);
  
  // 绘制热力图
  var heatmap = svg.selectAll(".heatmap")
      .data(data)
      .enter().append("rect")
      .attr("x", function(d) { return (d.Month - d3.min(data, function(d) { return d.Month; })) * gridSizeX; })
      .attr("y", function(d) { return (d.Year - d3.min(data, function(d) { return d.Year; })) * gridSizeY; })
      .attr("width", gridSizeX)
      .attr("height", gridSizeY)
      .style("fill", function(d) { return colorScale(d.Anomaly); });

  // 添加 tooltip
  var tooltip = d3.select("body")
      .append("div")
      .attr("class", "tooltip")
      .style("opacity", 0);

  heatmap.on("mouseover", function(d) {
      tooltip.transition()
          .duration(200)
          .style("opacity", .9);
      tooltip.html(d.Year + "-" + d.Month + ": " + d.Anomaly.toFixed(3))
          .style("left", (d3.event.pageX) + "px")
          .style("top", (d3.event.pageY - 28) + "px");
  })
  .on("mouseout", function(d) {
      tooltip.transition()
          .duration(500)
          .style("opacity", 0);
  });

  }); 

</script>

</body>
</html> 